import { Injectable, Logger } from '@nestjs/common';
import {
  EmbedBuilder,
  ActionRowBuilder,
  StringSelectMenuBuilder,
  StringSelectMenuInteraction,
  CacheType,
  ChannelType,
  PermissionFlagsBits,
  Guild,
} from 'discord.js';
import {
  Button,
  ButtonContext,
  Context,
  SlashCommandContext,
  StringSelect,
  StringSelectContext,
} from 'necord';
import { PrismaService } from 'src/prisma.service';
import { ServerRepository } from 'src/repository/server';
import { validateServerAndRole } from 'src/utils/server-validation.util';

@Injectable()
export class ServerClearService {
  private readonly logger = new Logger(ServerClearService.name);

  constructor(
    private readonly prisma: PrismaService,
    private readonly serverRepository: ServerRepository,
    // âŒ à¸•à¸±à¸” StageChannelService à¸—à¸´à¹‰à¸‡à¹€à¸à¸£à¸²à¸°à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ à¹à¸¥à¸°à¸—à¸³à¹ƒà¸«à¹‰ Nest à¸«à¸² dependency à¹„à¸¡à¹ˆà¹€à¸ˆà¸­
  ) {}

  public onModuleInit() {
    this.logger.log('ServerClearService initialized');
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // à¸›à¸¸à¹ˆà¸¡à¹€à¸£à¸´à¹ˆà¸¡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  @Button('server-set-room')
  async ServerClearSystem(@Context() interaction: SlashCommandContext | ButtonContext | any) {
    this.logger.debug('[ServerClearSystem] called');

    const validationError = await validateServerAndRole(
      interaction,
      'owner',
      this.serverRepository,
    );
    if (validationError) {
      this.logger.warn('[ServerClearSystem] Validation error:', validationError.message);
      return validationError;
    }

    const guild: Guild | null = interaction.guild;
    if (!guild) {
      this.logger.warn('[ServerClearSystem] No guild found');
      return this.replyError(interaction, 'âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¹„à¸”à¹‰');
    }

    // à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸ˆà¸£à¸´à¸‡ à¹†
    this.logger.debug(
      `[ServerClearSystem] Checking ownership: guild.ownerId=${guild.ownerId}, user.id=${interaction.user.id}`,
    );
    if (guild.ownerId !== interaction.user.id) {
      this.logger.warn(
        `[ServerClearSystem] User ${interaction.user.id} is not the owner of guild ${guild.id}`,
      );
      return this.replyError(
        interaction,
        'â›” à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸µà¹‰à¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰à¹€à¸‰à¸à¸²à¸° **à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ (Server Owner)** à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™',
      );
    }

    const server = await this.serverRepository.getServerById(interaction.guildId);
    if (!server) {
      this.logger.warn('[ServerClearSystem] Server not found for guildId:', interaction.guildId);
      return this.replyError(interaction, 'âŒ à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ à¹‚à¸›à¸£à¸”à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡!');
    }

    this.logger.debug('[ServerClearSystem] Server found:', server);

    const clearSelectionRow = new ActionRowBuilder<StringSelectMenuBuilder>().addComponents(
      new StringSelectMenuBuilder()
        .setCustomId('SELECT_MENU_CLEAR')
        .setPlaceholder('à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ')
        .addOptions([
          {
            label: 'ğŸ—ï¸ Clear All',
            value: 'clear_all',
            description: 'à¸¥à¸šà¸—à¸±à¹‰à¸‡à¸«à¹‰à¸­à¸‡ (Channel) à¹à¸¥à¸°à¸šà¸—à¸šà¸²à¸— (Role) à¸•à¸²à¸¡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸—à¸µà¹ˆà¸£à¸°à¸šà¸šà¸à¸³à¸«à¸™à¸”',
          },
          {
            label: 'ğŸ‘‹ Clear Channel',
            value: 'clear_channel',
            description: 'à¸¥à¸šà¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¸¢à¸à¹€à¸§à¹‰à¸™à¸«à¹‰à¸­à¸‡à¸£à¸°à¸šà¸šà¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™',
          },
          {
            label: 'ğŸ“° Clear Role',
            value: 'clear_role',
            description: 'à¸¥à¸šà¸šà¸—à¸šà¸²à¸—à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¸¢à¸à¹€à¸§à¹‰à¸™à¸šà¸—à¸šà¸²à¸—à¸—à¸µà¹ˆà¸ªà¸³à¸„à¸±à¸/à¸£à¸°à¸šà¸š',
          },
        ]),
    );

    const reply = await interaction.reply({
      embeds: [
        new EmbedBuilder()
          .setTitle('ğŸ“‹ à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ')
          .setDescription(
            `à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸—à¸µà¹ˆà¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸ˆà¸²à¸à¸£à¸²à¸¢à¸à¸²à¸£à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡:\n\n` +
              `- **Clear All**: à¸¥à¸šà¸—à¸±à¹‰à¸‡à¸«à¹‰à¸­à¸‡à¹à¸¥à¸°à¸šà¸—à¸šà¸²à¸—à¹ƒà¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ (à¸•à¸²à¸¡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚)\n` +
              `- **Clear Channel**: à¸¥à¸šà¹€à¸‰à¸à¸²à¸°à¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¸¢à¸à¹€à¸§à¹‰à¸™à¸«à¹‰à¸­à¸‡à¸£à¸°à¸šà¸šà¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”\n` +
              `- **Clear Role**: à¸¥à¸šà¹€à¸‰à¸à¸²à¸°à¸šà¸—à¸šà¸²à¸—à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¸¢à¸à¹€à¸§à¹‰à¸™à¸šà¸—à¸šà¸²à¸—à¸ªà¸³à¸„à¸±à¸ à¹€à¸Šà¹ˆà¸™ à¸šà¸—à¸šà¸²à¸—à¸«à¸¥à¸±à¸à¸‚à¸­à¸‡à¸£à¸°à¸šà¸š\n\n` +
              `âš ï¸ à¹‚à¸›à¸£à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸µà¹‰à¸”à¹‰à¸§à¸¢à¸„à¸§à¸²à¸¡à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡ à¸à¸²à¸£à¸¥à¸šà¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸à¸¹à¹‰à¸„à¸·à¸™à¹„à¸”à¹‰\n\n` +
              `â° **à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸**: à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸ˆà¸°à¸«à¸²à¸¢à¹„à¸›à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹ƒà¸™ 1 à¸™à¸²à¸—à¸µ`,
          )
          .setColor(0x00bfff),
      ],
      components: [clearSelectionRow],
      ephemeral: true,
    });

    setTimeout(
      async () => {
        try {
          await reply.delete();
          this.logger.debug('[ServerClearSystem] Auto-deleted menu message after 1 minute');
        } catch (error: any) {
          this.logger.warn(
            '[ServerClearSystem] Failed to auto-delete menu message:',
            error.message,
          );
        }
      },
      60_000,
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // à¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸¥à¸·à¸­à¸à¸ˆà¸²à¸ Select Menu
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  @StringSelect('SELECT_MENU_CLEAR')
  public async handleRoomRegistration(@Context() interaction: StringSelectContext | any) {
    this.logger.debug('[handleRoomRegistration] called, id:', interaction.id ?? 'no-id');

    await interaction.update({
      embeds: [
        new EmbedBuilder()
          .setTitle('âš¡ à¸à¸³à¸¥à¸±à¸‡à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£...')
          .setDescription(
            `ğŸ”„ **à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“**\n\n` +
              `ğŸ“‹ **à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸:** \`${interaction.values[0].toUpperCase()}\`\n` +
              `â³ **à¸ªà¸–à¸²à¸™à¸°:** à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œ...\n\n` +
              `â° **à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸:** à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸ˆà¸°à¸«à¸²à¸¢à¹„à¸›à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹ƒà¸™ 20 à¸§à¸´à¸™à¸²à¸—à¸µ`,
          )
          .setColor(0xffa500),
      ],
      components: [],
    });

    const server = await this.serverRepository.getServerById(interaction.guildId);
    if (!server) {
      this.logger.warn('[handleRoomRegistration] Server not found for guildId:', interaction.guildId);
      return this.editReplyError(interaction, 'âŒ à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ');
    }

    this.logger.debug('[handleRoomRegistration] Server found:', server);

    const clearStatus = interaction.values[0];
    this.logger.debug('[handleRoomRegistration] Mode:', clearStatus);

    try {
      if (clearStatus === 'clear_all') {
        await this.clearChannel(interaction);
        await this.clearRole(interaction);
        return this.replySuccess(interaction, 'clear_all');
      } else if (clearStatus === 'clear_channel') {
        await this.clearChannel(interaction);
        return this.replySuccess(interaction, 'clear_channel');
      } else {
        await this.clearRole(interaction);
        return this.replySuccess(interaction, 'clear_role');
      }
    } catch (error: any) {
      this.logger.error('[handleRoomRegistration] Error while clearing:', error);

      let errorMessage = 'âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸à¸²à¸£à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ';
      if (error.message === 'Missing Permissions') {
        errorMessage = 'âŒ à¸à¸£à¸¸à¸“à¸²à¹ƒà¸«à¹‰à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸šà¸—à¸šà¸²à¸—à¸‚à¸±à¹‰à¸™à¸ªà¸¹à¸‡à¸à¸±à¸š Bot (à¸ˆà¸±à¸”à¸¥à¸³à¸”à¸±à¸š Role à¹ƒà¸«à¹‰ Bot à¸­à¸¢à¸¹à¹ˆà¸ªà¸¹à¸‡à¸ªà¸¸à¸”)';
      }

      const reply = await interaction.editReply({
        embeds: [
          new EmbedBuilder()
            .setTitle('âš ï¸ à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”')
            .setDescription(errorMessage + '\n\nâ° **à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸ˆà¸°à¸«à¸²à¸¢à¹„à¸›à¹ƒà¸™ 20 à¸§à¸´à¸™à¸²à¸—à¸µ**')
            .setColor(0xff0000),
        ],
        components: [],
      });

      setTimeout(
        async () => {
          try {
            if (interaction.message) {
              await interaction.message.delete();
              this.logger.debug(
                '[handleRoomRegistration] Auto-deleted error message after 20 seconds',
              );
            }
          } catch (err: any) {
            this.logger.warn(
              '[handleRoomRegistration] Failed to auto-delete error message:',
              err.message,
            );
          }
        },
        20_000,
      );

      return reply;
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // à¸¥à¸š Channel à¸—à¸±à¹‰à¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ (à¸¢à¸à¹€à¸§à¹‰à¸™à¸šà¸²à¸‡à¸«à¹‰à¸­à¸‡)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  private async clearChannel(interaction: StringSelectMenuInteraction<CacheType> | any) {
    this.logger.debug('[clearChannel] called');
    const guild: Guild | null = interaction.guild;

    if (!guild) {
      this.logger.error('[clearChannel] No guild found');
      throw new Error('GUILD_NOT_FOUND');
    }

    // à¸à¸±à¸™à¹€à¸„à¸ª interaction à¸–à¸¹à¸ reuse à¹‚à¸”à¸¢à¸„à¸™à¸­à¸·à¹ˆà¸™ (double check owner)
    if (guild.ownerId !== interaction.user.id) {
      this.logger.warn(
        `[clearChannel] User ${interaction.user.id} is not the owner of guild ${guild.id}`,
      );
      throw new Error('NOT_GUILD_OWNER');
    }

    const channels = guild.channels.cache;
    const excludeChannels = ['Me-Guild-Set-Server', 'rules', 'moderator-only'];

    this.logger.debug(
      `[clearChannel] Found ${channels.size} channels, excluding: ${excludeChannels.join(', ')}`,
    );

    let meguildChannel = channels.find(
      (channel) => channel.name === 'Me-Guild-Set-Server' && channel.isTextBased(),
    );

    for (const [channelId, channel] of channels) {
      if (excludeChannels.includes(channel.name)) {
        this.logger.debug(
          `[clearChannel] Skipped deleting channel: ${channel.name} (${channelId})`,
        );
        continue;
      }

      try {
        await channel.delete(`Deleted by ${interaction.user.tag}`);
        this.logger.log(`[clearChannel] Deleted channel: ${channel.name} (${channelId})`);
      } catch (err: any) {
        this.logger.error(
          `[clearChannel] Failed to delete channel ${channel.name} (${channelId}): ${err.message}`,
        );
      }
    }

    if (!meguildChannel) {
      this.logger.debug('[clearChannel] Creating Me-Guild-Set-Server');

      meguildChannel = await guild.channels.create({
        name: 'Me-Guild-Set-Server',
        type: ChannelType.GuildText,
        reason: `Created by ${interaction.user.tag} after clearing other channels`,
        permissionOverwrites: [
          {
            id: guild.id,
            deny: [PermissionFlagsBits.ViewChannel],
          },
          {
            id: interaction.user.id,
            allow: [
              PermissionFlagsBits.ViewChannel,
              PermissionFlagsBits.SendMessages,
              PermissionFlagsBits.ManageChannels,
            ],
          },
        ],
      });

      this.logger.log(
        `[clearChannel] Created channel: ${meguildChannel.name} (${meguildChannel.id})`,
      );
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // à¸¥à¸š Role à¸—à¸±à¹‰à¸‡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ (à¸¢à¸à¹€à¸§à¹‰à¸™à¸šà¸²à¸‡à¸šà¸—à¸šà¸²à¸—)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  private async clearRole(interaction: StringSelectMenuInteraction<CacheType> | any) {
    this.logger.debug('[clearRole] called');
    const guild: Guild | null = interaction.guild;

    if (!guild) {
      this.logger.error('[clearRole] No guild found');
      throw new Error('GUILD_NOT_FOUND');
    }

    const excludeRoles = ['à¸à¸£à¸°à¹€à¸ˆà¹‰à¸²à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡', 'à¹à¸—à¹ˆà¸™à¸‚à¸­à¸à¸£', '@everyone'];
    const roles = guild.roles.cache;

    if (roles.size === 0) {
      this.logger.warn('[clearRole] No roles found');
      return;
    }

    for (const [roleId, role] of roles) {
      if (role.name === '@everyone' || excludeRoles.includes(role.name)) {
        this.logger.log(`[clearRole] Skip excluded role: ${role.name} (${roleId})`);
        continue;
      }

      if (role.managed || role.id === guild.id) {
        this.logger.log(
          `[clearRole] Skip managed/system role: ${role.name} (${roleId})`,
        );
        continue;
      }

      try {
        await role.delete(`Deleted by ${interaction.user.tag}`);
        this.logger.log(`[clearRole] Deleted role: ${role.name} (${roleId})`);
      } catch (err: any) {
        this.logger.error(
          `[clearRole] Failed to delete role: ${role.name} (${roleId}). Error: ${err.message}`,
        );
      }
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Helper: à¹à¸ªà¸”à¸‡ Error/Success
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private async editReplyError(interaction: any, message: string) {
    const reply = await interaction.editReply({
      embeds: [
        new EmbedBuilder()
          .setTitle('âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”')
          .setDescription(message + '\n\nâ° **à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸ˆà¸°à¸«à¸²à¸¢à¹„à¸›à¹ƒà¸™ 20 à¸§à¸´à¸™à¸²à¸—à¸µ**')
          .setColor(0xff0000),
      ],
    });

    setTimeout(
      async () => {
        try {
          if (interaction.message) {
            await interaction.message.delete();
            this.logger.debug('[editReplyError] Auto-deleted error message after 20 seconds');
          }
        } catch (error: any) {
          this.logger.warn(
            '[editReplyError] Failed to auto-delete error message:',
            error.message,
          );
        }
      },
      20_000,
    );

    return reply;
  }

  private async replySuccess(interaction: any, mode: string) {
    let description = '';

    if (mode === 'clear_all') {
      description =
        `ğŸ‰ à¸£à¸°à¸šà¸šà¹„à¸”à¹‰à¸—à¸³à¸à¸²à¸£ **à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸«à¹‰à¸­à¸‡ (Channel) à¹à¸¥à¸°à¸šà¸—à¸šà¸²à¸— (Role)** à¹ƒà¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§\n` +
        `- à¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸–à¸¹à¸à¸¥à¸š: à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸¢à¸à¹€à¸§à¹‰à¸™à¸«à¹‰à¸­à¸‡à¸£à¸°à¸šà¸šà¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸” (à¹€à¸Šà¹ˆà¸™ \`Me-Guild-Set-Server\`, \`rules\`)\n` +
        `- à¸šà¸—à¸šà¸²à¸—à¸—à¸µà¹ˆà¸–à¸¹à¸à¸¥à¸š: à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸¢à¸à¹€à¸§à¹‰à¸™à¸šà¸—à¸šà¸²à¸—à¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆà¸£à¸°à¸šà¸šà¸¢à¸à¹€à¸§à¹‰à¸™\n`;
    } else if (mode === 'clear_channel') {
      description =
        `ğŸ‰ à¸£à¸°à¸šà¸šà¹„à¸”à¹‰à¸—à¸³à¸à¸²à¸£ **à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ** à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§\n` +
        `- à¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸–à¸¹à¸à¸¥à¸š: à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸¢à¸à¹€à¸§à¹‰à¸™à¸«à¹‰à¸­à¸‡à¸£à¸°à¸šà¸šà¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”\n` +
        `- à¸«à¹‰à¸­à¸‡ \`Me-Guild-Set-Server\` à¸–à¸¹à¸à¸ªà¸£à¹‰à¸²à¸‡/à¹€à¸à¹‡à¸šà¹„à¸§à¹‰à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š MeGuild\n`;
    } else if (mode === 'clear_role') {
      description =
        `ğŸ‰ à¸£à¸°à¸šà¸šà¹„à¸”à¹‰à¸—à¸³à¸à¸²à¸£ **à¸¥à¸šà¸šà¸—à¸šà¸²à¸— (Role) à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¥à¸šà¹„à¸”à¹‰** à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§\n` +
        `- à¸¢à¸à¹€à¸§à¹‰à¸™à¸šà¸—à¸šà¸²à¸—: \`à¸à¸£à¸°à¹€à¸ˆà¹‰à¸²à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡\`, \`à¹à¸—à¹ˆà¸™à¸‚à¸­à¸à¸£\`, \`@everyone\`\n`;
    } else {
      description = 'ğŸ‰ à¸£à¸°à¸šà¸šà¹„à¸”à¹‰à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§';
    }

    const reply = await interaction.editReply({
      embeds: [
        new EmbedBuilder()
          .setTitle('âœ… à¸à¸²à¸£à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¸ªà¸³à¹€à¸£à¹‡à¸ˆ')
          .setDescription(description + `\nâ° **à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸ˆà¸°à¸«à¸²à¸¢à¹„à¸›à¹ƒà¸™ 20 à¸§à¸´à¸™à¸²à¸—à¸µ**`)
          .setColor(0x00ff00),
      ],
      components: [],
    });

    setTimeout(
      async () => {
        try {
          if (interaction.message) {
            await interaction.message.delete();
            this.logger.debug('[replySuccess] Auto-deleted success message after 20 seconds');
          }
        } catch (error: any) {
          this.logger.warn(
            '[replySuccess] Failed to auto-delete success message:',
            error.message,
          );
        }
      },
      20_000,
    );

    return reply;
  }

  private replyError(interaction: any, message: string) {
    return interaction.reply({
      embeds: [
        new EmbedBuilder()
          .setTitle('âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”')
          .setDescription(message)
          .setColor(0xff0000),
      ],
      ephemeral: true,
    });
  }
}
